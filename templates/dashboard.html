{% extends 'layout.html' %}
{% block content %}
<h2 class="mb-3">Dashboard</h2>

<!-- KPIs -->
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="card border-primary">
      <div class="card-body">
        <h5 class="card-title">Recargas</h5>
        <p class="card-text fs-4">{{ kpis.total_recargas }}</p>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card border-info">
      <div class="card-body">
        <h5 class="card-title">kWh Total</h5>
        <p class="card-text fs-4">{{ kpis.total_kwh | round(2) }}</p>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card border-warning">
      <div class="card-body">
        <h5 class="card-title">Custo Total (R$)</h5>
        <p class="card-text fs-4">{{ kpis.total_custo | round(2) }}</p>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card border-success">
      <div class="card-body">
        <h5 class="card-title">KM Rodados</h5>
        <p class="card-text fs-4">{{ kpis.total_km | round(1) }}</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Custo Médio / kWh</h6>
        <p class="card-text">R$ {{ kpis.custo_medio_kwh | round(3) }}</p>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Custo Médio / km</h6>
        <p class="card-text">R$ {{ kpis.custo_medio_km | round(3) }}</p>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Economia Total</h6>
        <p class="card-text text-success">R$ {{ kpis.economia_total | round(2) }}</p>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">Economia Média / km</h6>
        <p class="card-text text-success">R$ {{ kpis.economia_media_km | round(3) }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Tabela de Recargas -->
{% if recargas and recargas|length > 0 %}
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>Data</th>
        <th>kWh</th>
        <th>Custo (R$)</th>
        <th>Odômetro (km)</th>
        <th>Local</th>
        <th>Observações</th>
      </tr>
    </thead>
    <tbody>
      {% for r in recargas %}
      <tr>
        <td>{{ r[0] }}</td>
        <td>{{ r[1] }}</td>
        <td>{{ r[2] }}</td>
        <td>{{ r[3] }}</td>
        <td>{{ r[4] }}</td>
        <td>{{ r[5] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p>Nenhuma recarga registrada ainda.</p>
{% endif %}


<!-- Gráficos interativos -->
<div class="mt-4">
  <h5>Evolução de Consumo (kWh) e Custo (R$) por Data</h5>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">kWh por Data</h6>
          <canvas id="chartKwh" style="max-height: 360px;"></canvas>
          <p id="emptyKwh" class="text-muted small d-none">Nenhum dado para exibir.</p>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Custo (R$) por Data</h6>
          <canvas id="chartCusto" style="max-height: 360px;"></canvas>
          <p id="emptyCusto" class="text-muted small d-none">Nenhum dado para exibir.</p>
        </div>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
<script>
(async function () {
  try {
    const res = await fetch("{{ url_for('api_recharges') }}", { cache: "no-store" });
    const data = await res.json();
    const labels = data.labels || [];
    const kwh = data.kwh || [];
    const custo = data.custo || [];

    // Formatação BRL para tooltips
    const fmtBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

    // Estado vazio
    const hasData = labels.length > 0;
    document.getElementById('emptyKwh').classList.toggle('d-none', hasData);
    document.getElementById('emptyCusto').classList.toggle('d-none', hasData);

    if (!hasData) return;

    // Gráfico de Linha (kWh)
    const ctxKwh = document.getElementById('chartKwh');
    new Chart(ctxKwh, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'kWh',
          data: kwh,
          borderColor: '#0d6efd',   // azul Bootstrap
          backgroundColor: 'rgba(13,110,253,0.15)',
          tension: 0.25,
          pointRadius: 3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (ctx) => `kWh: ${ctx.parsed.y.toFixed(2)}`
            }
          }
        },
        scales: {
          x: { title: { text: 'Data', display: true } },
          y: {
            title: { text: 'kWh', display: true },
            beginAtZero: true
          }
        }
      }
    });

    // Gráfico de Barras (Custo)
    const ctxCusto = document.getElementById('chartCusto');
    new Chart(ctxCusto, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Custo (R$)',
          data: custo,
          borderColor: '#ffc107',     // amarelo Bootstrap
          backgroundColor: 'rgba(255,193,7,0.45)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (ctx) => `Custo: ${fmtBRL(ctx.parsed.y)}`
            }
          }
        },
        scales: {
          x: { title: { text: 'Data', display: true } },
          y: {
            title: { text: 'R$', display: true },
            beginAtZero: true
          }
        }
      }
    });

  } catch (err) {
    console.error('Erro ao carregar dados do gráfico:', err);
    // Se necessário, mostrar um alerta amigável ao usuário:
    // alert('Falha ao carregar dados do gráfico.');
    document.getElementById('emptyKwh').classList.remove('d-none');
    document.getElementById('emptyCusto').classList.remove('d-none');
  }
})();

</script>
{% endblock scripts %}
{% endblock content %}


